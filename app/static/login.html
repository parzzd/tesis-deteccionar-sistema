<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sistema de Deteccion</title>
<style>
  :root{--bg:#0b0f17;--panel:#0f1522;--card:#0e1421;--mut:#9aa4b2;--txt:#e6edf3;--b:#1e2636;--btn:#335cce}
  *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--txt)}
  .wrap{min-height:100vh;display:grid;place-items:center;background:radial-gradient(80% 60% at 50% 10%,#0f1729 0%,#0b0f17 60%)}
  .shell{width:min(92vw,520px);background:rgba(12,18,30,.8);border:1px solid #1a2234;border-radius:18px;box-shadow:0 10px 40px rgba(0,0,0,.35);padding:28px}
  .logo{display:flex;align-items:center;gap:10px;margin-bottom:16px}
  .badge{width:34px;height:34px;border-radius:50%;border:2px solid #6aa7ff;display:grid;place-items:center}
  h1{font-size:28px;margin:0;font-weight:800;letter-spacing:.3px}
  h2{margin:12px 0 14px;font-size:18px;font-weight:700}
  label{display:block;margin:10px 0 6px;color:var(--mut);font-size:13px}
  .in{width:100%;padding:12px 14px;border-radius:12px;background:var(--card);border:1px solid var(--b);color:var(--txt);outline:none}
  .row{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
  .mut{color:var(--mut);font-size:13px}
  .btn{width:100%;padding:12px 14px;border:none;border-radius:12px;background:var(--btn);color:#fff;cursor:pointer;font-weight:600}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .foot{margin-top:10px;text-align:right}
  a{color:#8fb3ff;text-decoration:none}
  .err{display:none;margin-bottom:10px;background:#3a1116;border:1px solid #6b1f28;color:#ffb4b8;padding:10px;border-radius:10px;font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <div class="shell">
    <div class="logo">
      <div class="badge">üõ°Ô∏è</div>
      <h1>T√©sis de Detecci√≥n</h1>
    </div>

    <h2>Iniciar sesi√≥n</h2>
    <div id="err" class="err"></div>
    <div id="tries" class="text-sm text-gray-500 mt-2" style="display:none;"></div>

    <label>Nombre de usuario</label>
    <input id="email" class="in" placeholder="usuario@vigilia.io" autocomplete="username"/>

    <label>Contrase√±a</label>
    <input id="password" type="password" class="in" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/>

    <div class="row">
      <label class="mut" style="display:flex;align-items:center;gap:8px">
        <input id="remember" type="checkbox" style="accent-color:#5f89ff"/> Recu√©rdame
      </label>
      <div class="mut"><a href="#" onclick="alert('Pide a un admin restablecer tu clave.');return false;">¬øOlvid√≥ su contrase√±a?</a></div>
    </div>

    <div style="margin-top:14px"><button id="btn" class="btn">Iniciar sesi√≥n</button></div>


    <div class="foot"><span class="mut">Espa√±ol ‚ñæ</span></div>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
const tokenKey = 'sicher.token', emailKey = 'sicher.email';

// Recuperar email recordado
const remembered = localStorage.getItem(emailKey);
if (remembered) {
  $('#email').value = remembered;
  $('#remember').checked = true;
}

async function doLogin() {
  const btn = $('#btn');
  const errBox = $('#err');
  const triesBox = $('#tries');
  const email = $('#email').value.trim();
  const password = $('#password').value;

  errBox.style.display = 'none';
  triesBox.style.display = 'none';
  btn.disabled = true;

  try {
    const res = await fetch('/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });

    const data = await res.json().catch(() => ({}));

    // üîí Caso: bloqueado temporalmente
    if (res.status === 403 && data.blocked) {
      errBox.textContent = data.error || 'Usuario bloqueado. Intenta m√°s tarde.';
      errBox.style.display = 'block';
      window.location.href = "/static/login_fail.html";
      return;
    }

    // ‚ö†Ô∏è Caso: error de autenticaci√≥n
    if (!res.ok) {
      errBox.textContent = data.error || 'Credenciales inv√°lidas.';
      errBox.style.display = 'block';

      if (data.attempts && data.max_attempts)
        triesBox.textContent = `Intento ${data.attempts} de ${data.max_attempts}`;
      triesBox.style.display = 'block';

      btn.disabled = false;
      return;
    }

    // ‚úÖ Caso: login exitoso
    if ($('#remember').checked)
      localStorage.setItem(emailKey, email);
    else
      localStorage.removeItem(emailKey);

    localStorage.removeItem('failedAttempts');
    localStorage.setItem(tokenKey, data.access_token);
    localStorage.setItem('sicher.email', email);

    window.location.href = '/static/index.html';
  } catch (err) {
    console.error(err);
    errBox.textContent = 'Error de conexi√≥n con el servidor.';
    errBox.style.display = 'block';
  } finally {
    btn.disabled = false;
  }
}

$('#btn').onclick = doLogin;
document.addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
</script>
</body>
</html>
